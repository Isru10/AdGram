"use client";

import { useEffect, useState } from "react";
import { useSession } from "next-auth/react";
import Link from "next/link";
import { formatDistanceToNow } from 'date-fns';

type Chat = {
  _id: string;
  ad: { title: string };
  buyer: { _id: string, name: string };
  seller: { _id: string, name: string };
  unreadByBuyer: number;
  unreadBySeller: number;
  updatedAt: string;
};

export default function ChatsPage() {
  const { data: session } = useSession();
  const [chats, setChats] = useState<Chat[]>([]);
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    const fetchChats = async () => {
      try {
        const res = await fetch("/api/chats");
        if (res.ok) {
          const data = await res.json();
          setChats(data);
        }
      } catch (error) {
        console.error("Failed to fetch chats:", error);
      } finally {
        setIsLoading(false);
      }
    };
    fetchChats();
  }, []);
  
  if (isLoading) return <p className="text-center p-10 text-slate-400">Loading inbox...</p>;

  return (
    <div className="container mx-auto max-w-3xl p-4 md:p-6">
        <h1 className="text-3xl font-bold mb-6 text-white">Inbox</h1>
        {/* The main container for the list of chats */}
        <div className="space-y-0">
            {chats.length > 0 ? (
                // --- FIX STARTS HERE ---
                // 1. Changed <ul> to a <div> with flexbox properties.
                //    - `flex flex-col` stacks the items vertically.
                //    - `gap-3` adds a small gap between each item.
                <div className="flex flex-col gap-3">
                    {chats.map(chat => {
                        const otherUser = session?.user?.id === chat.seller._id ? chat.buyer : chat.seller;
                        
                        let hasUnreadMessages = false;
                        if (session?.user?.id === chat.buyer._id) {
                            hasUnreadMessages = chat.unreadByBuyer > 0;
                        } else if (session?.user?.id === chat.seller._id) {
                            hasUnreadMessages = chat.unreadBySeller > 0;
                        }

                        const cardColor = hasUnreadMessages
                          ? "bg-green-600/20 hover:bg-green-600/30"
                          : "bg-slate-800 hover:bg-slate-700/50"; // Added a base color for read messages

                        const lastMessageDate = formatDistanceToNow(new Date(chat.updatedAt), {
                          addSuffix: true,
                        });

                        return (
                            // 2. Changed <li> to a simple <div>
                            <div key={chat._id}>
                                <Link href={`/chats/${chat._id}`} className={`block p-4 transition-colors rounded-xl border border-slate-700 ${cardColor}`}>
                                    <div className="flex justify-between items-start">
                                      <div>
                                        <p className="font-semibold text-white">{otherUser.name}</p>
                                        <p className="text-sm text-slate-400 mt-1">Reply to : {chat.ad.title}</p>
                                      </div>
                                      <div className="flex flex-col items-end flex-shrink-0 ml-4">
                                        <p className="text-xs text-slate-500 mb-1">{lastMessageDate}</p>
                                        {hasUnreadMessages && (
                                          <span className="text-xs font-bold text-green-400 bg-green-900/50 px-2 py-1 rounded-full">New</span>
                                        )}
                                      </div>
                                    </div>
                                </Link>
                            </div>
                        );
                    })}
                </div>
                // --- FIX ENDS HERE ---
            ) : (
                <div className="bg-slate-800 rounded-xl border border-slate-700 p-6 text-slate-400">
                    You have no conversations yet.
                </div>
            )}
        </div>
    </div>
  );
}